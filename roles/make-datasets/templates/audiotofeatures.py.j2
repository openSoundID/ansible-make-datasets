#!/usr/bin/env python3

import essentia
import essentia.standard
import sys
from essentia.standard import *

#############################

inputfilename=sys.argv[1]
outputfilename=sys.argv[2]

#############################


loader = MonoLoader(filename=inputfilename)
w = Windowing(type = '{{ essentia_windowtype }}')
spectrum = Spectrum(size={{ essentia_spectrumsize }})
pool = essentia.Pool()
mfcc = MFCC(lowFrequencyBound={{ essentia_lowfrequencybound }},highFrequencyBound={{ essentia_highfrequencybound }},sampleRate={{ essentia_samplerate }},numberBands={{ essentia_mfcc_numberbands }},normalize='{{ essentia_mfcc_normalize }}',warpingFormula='{{ essentia_mfcc_warpingFormula }}',weighting='{{ essentia_mfcc_weighting }}')
energy = Energy()
zerocrossingrate = ZeroCrossingRate(threshold={{ essentia_zerocrossingrate_threshold }})
envelope = Envelope(attackTime={{ essentia_envelope_attackTime }},releaseTime={{ essentia_envelope_releaseTime }},sampleRate={{ essentia_samplerate }})
flatness = FlatnessSFX()

logNorm = UnaryOperator(type='{{ essentia_logNorm_type }}')

#############################

mfccs = []
melbands = []
melbands_log = []
audio = loader()

zcr = zerocrossingrate(audio)
signal_envelope=envelope(audio)
signal_flatness=flatness(signal_envelope)

pool.add('description.zero_crossing_rate', zcr)
pool.add('description.envelope', signal_envelope)
pool.add('description.flatness', signal_flatness)

for frame in FrameGenerator(audio, frameSize = {{ essentia_framesize }}, hopSize = {{ essentia_hopsize }}, startFromZero=True):
    mfcc_bands, mfcc_coeffs = mfcc(spectrum(w(frame)))
    frame_energy = energy(w(frame))
    pool.add('lowlevel.mfcc_bands_log', logNorm(mfcc_bands))
    pool.add('lowlevel.energy', frame_energy)

output = YamlOutput(filename = outputfilename,format = 'json') 
output(pool)


